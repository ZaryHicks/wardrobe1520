{% extends '_base.html' %}
{% block header %}
My Current Wardrobe
{% endblock %}
{% block content %}

<!-- Add item modal -->
<div class="Modal fade" id="myModal">
    <div class="modal-dialog" align="center">
        
        <!-- Modal Content -->
        <div class="modal-content" align="center">
            <div class="modal-body" align="center">
                <form class="form-main" id="addItemForm" method="post" action="/add" onsubmit="return addClothes();" align="center">
                    <!-- Title -->
                    <h2 class="text-center w-color-1" align="center">Add Item</h2>
                    
                    <!-- Clothing Type -->
                    <!-- is there a way to have the form change based on the type we select? - then the type doesnt need to be in the form and is just hardcoded -->
                    <div class="form-group">
                        <label class="w-color-1">Type</label>
                        <Select name="type" id="typesel" class="form-control" align="center">
                            <option name="type" value="Jacket">Jacket
                            <option name="type" value="Shirt">Shirt
                            <option name="type" value="Pants">Pants
                            <option name="type" value="Shoes">Shoes
                        </Select> 
                    </div>

                    <!-- div for shorts and short sleeves will get to later
                    <div class="form-group" id="shorts">
                        <label class="w-color-1">Are they shorts?</label>
                        <Select name="formal" class="form-control">
                            <option name="formal" value="False">Yes
                            <option name="formal" value="True">No
                        </Select> 
                    </div>-->

                    <!-- Item Name -->
                    <div class="form-group">
                        <label class="w-color-1">Name</label>
                        <input type="input" name="name" class="form-control" id="name" required>
                    </div>

                    <!-- Item Color -->
                    <div class="form-group">
                        <label class="w-color-1">Color</label>
                        <input type="color" name="color" class="form-control" id="color" required>
                    </div>

                    <!-- Item Casual Dropdown -->
                    <div class="form-group">
                        <label class="w-color-1">Is it casual?</label>
                        <Select name="casual" class="form-control" id="casual">
                            <option name="casual" value="True">Yes
                            <option name="casual" value="False">No
                        </Select> 
                    </div>

                    <!-- Item Max Temp -->
                    <div class="form-group">
                        <label class="w-color-1">High temperature</label>
                        <input type="number" name="high" class="form-control" id="high" required>
                    </div>

                    <!-- Item Min Temp -->
                    <div class="form-group">
                        <label class="w-color-1">Low temperature</label>
                        <input type="number" name="low" class="form-control" id="low" required>
                    </div>

                    <!-- Div for errors -->
                    <div id="validater"></div>

                    <!-- Submit Form -->
                    <div class="form-group">
                        <input type="submit" value="Submit" class="btn btn-primary w-bg-color-1">
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- JS that clears the form in the add item modal when the modal is closed (on submission or otherwise) -->
<script>
$(document).ready(function(){
  $("#myModal").on('hidden.bs.modal', function(){
    $(this).find('form')[0].reset();
  });
});
</script>

<!-- JS that populates the table with the user's clothing items -->
<script type=text/javascript>
    //define root to main
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    
    //*** IF we want to change how the data in the table looks, we can easily modify it in /get_wardrobe BEFORE we return it here
    //So formatting and some other things could be done on the data easily in python and then that could be sent up to the table

    //call this function when the page loads
    $(function() {
        //make a get request to /get_wardrobe, which returns JSON of the user's clothing items
        $.get($SCRIPT_ROOT + '/get_wardrobe', function(data) {
            //add their items to the table
            //console.log(JSON.parse(data))
            $('#table').bootstrapTable({data : JSON.parse(data)});
        });
        
        return false;
    });
</script>

<div class="row vhm-60 m-0">
    <div class="col-sm-3 w-bg-color-1 p-3 text-center flexbox">
        <h4>Wardrobe</h4>
         <!--<p class="text-center p-3 m-0">Click <b>Add Item</b> to add a new article of clothing to your Wardrobe<br>
        Check item(s) and click <b>Remove Item</b> to remove an article of clothing
        </p>-->
        <div>
            <!-- Add Item opens a modal window with a form for creating a clothing item -->
            <button type="button" class="btn btn-primary my-3 w-70" data-toggle="modal" data-target="#myModal">Add Item</button>
            <!-- Remove Item will remove all of the items that are checked in the table from the wardrobe -->
            <button type="button" class="btn btn-secondary my-3 w-70" id="remover">Remove Item</button>
        </div>
    </div>
    <div class="col-sm-9 p-0">
        <div>
            <table id="table"
                data-checkbox-header="false"
                data-click-to-select="true"
                thead-classes="thead-light">
                <thead>
                    <tr>
                        <th data-field="state" data-checkbox="true" >Remove</th>
                        <th data-field="id" data-sortable="true" data-visible="false">ID</th>
                        <th data-field="type" data-sortable="true">Type</th>
                        <th data-field="name" data-sortable="true">Name</th>
                        <th data-field="color" data-sortable="true">Color</th>
                        <th data-field="is_casual" data-sortable="true">Casual</th>
                        <th data-field="high_temp" data-sortable="true">High</th>
                        <th data-field="low_temp" data-sortable="true">Low</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- Recommendations Section (Bootsrap JS Carousel Part of Options) -->
<div class="row min-vh-100 m-0">
    <div class="form-generate col-sm-3 w-bg-color-1 p-0 flexbox">
        <form method="post" action="/generate"class="text-center p-3">
            <h4 class="py-3">Recommend</h4>
            <h6 class="m-0">Temperature (°F)</h6>
            <input type="text" id="temp-generate" name="temp" value="45" class="form-control text-center w-bg-color-1"> <!-- HARDCODED, need darksky --> 
            <h6 class="m-0">Casual</h6>
            <select id="casual-generate" name="casual-generate" class="form-control w-bg-color-1">
                <option value="True">Yes</option>
                <option value="False">No</option>
            </select>
            <input type="submit" value="Generate" class="btn btn-primary mt-3">
        </form>
    </div>

    
    <div class="col-sm-9 showcase-background-welcome-blur">
        <div class="row  align-items-center h-100">
            <div class= "col-sm-7">
                <div id="outfit-image-container">
                    <object class="outfit-image" type="image/svg+xml" data="/static/images/outfit.svg"></object>
                </div>
            </div>
            <div class="col-sm-5 text-center flexbox">
            <button class="btn my-3 btn-secondary" id="change-jacket">Change Jacket</button>
            <button class="btn my-3 btn-secondary" id="change-shirt">Change Shirt</button>
            <button class="btn my-3 btn-secondary" id="change-pants">Change Pants</button>
            <button class="btn my-3 btn-secondary" id="change-shoes">Change Shoes</button>

            <div id="outfit-text">
                <div class="notice">Generate outfits to see options here</div>
                <div class="jackets"></div>
                <div class="shirts"></div>
                <div class="pants"></div>
                <div class="shoes"></div>
                <div id="twitter-share-button-div"></div>
                <a class="twitter-share-button-temp"
                    style="display:none;"
                    href="https://twitter.com/intent/tweet"
                    data-size="large"
                    data-text="custom share text"
                    data-url="https://dev.twitter.com/web/tweet-button">
                    Tweet
                </a>
                <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Recommendations Section (table part of options) -->
<div class="container-fluid w-bg-color-1 all-combos-container overflow-auto">
    <h3 class=" text-center p-3">All Outfit Combinations</h3>
    <div id="all-combos"></div>
</div>

<script>
// get temp value for autofill in form
document.getElementById("temp-generate").value = localStorage.getItem('Temp').substring(0, localStorage.getItem('Temp').indexOf('°'));
// helper functions
function getTypes(type, array)
{
    var typeArr = []
    for(i = 0; i < array.length; i++)
    {
        if(array[i].type === type)
        {
            typeArr.push(array[i]);
        }
    }
    return typeArr;
}

function circleI(i, array)
{
    if(i+1 >= array.length)
        return 0;
    else
        return i+1;
}

function updateTweet(jackets, indexJackets, shirts, indexShirts, pants, indexPants, shoes, indexShoes)
{
    var defaultText = 'Hey'+/*' @jakestambaugh '+*/'! My outfit of the day is \n'
    var newText = defaultText;
    if(jackets.length > 0) { newText = newText+('Jacket: ' + jackets[indexJackets].name+"\n"); }
    if(shirts.length > 0) { newText = newText+('Shirt: ' + shirts[indexShirts].name+"\n"); }
    if(pants.length > 0) { newText = newText+('Pants: ' + pants[indexPants].name+"\n"); }
    if(shoes.length > 0) { newText = newText+('Shoes: ' + shoes[indexShoes].name+"\n"); }
    $('#twitter-share-button-div').empty()
    if(newText !== defaultText){    
        var clone = $('.twitter-share-button-temp').clone();
        clone.removeAttr("style");
        clone.attr("data-text", newText);
        clone.attr("data-url", "http://wardrobe-268517.appspot.com/"); 
        clone.attr("class", "twitter-share-button"); 

        $('#twitter-share-button-div').append(clone);
        //$.getScript("http://platform.twitter.com/widgets.js");
        twttr.widgets.load();
    }
}
// script to handle generate form
$('.form-generate form').submit(function(event){
    event.preventDefault();

    var casualGenerate = document.getElementById('casual-generate').value;
    var tempGenerate = document.getElementById('temp-generate').value;
    $.ajax({
        type : "POST",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        url : "/generate?clothes=yes",
        data: JSON.stringify({
                  'casual-generate': casualGenerate,
                  'temp-generate': tempGenerate,
               }),
        success: function (response, status) {
            //console.log(status);
            var items = response;
            //console.log(response);

            //show buttons
            $("#change-jacket, #change-shirt, #change-pants, #change-shoes").css(
                "display", "block");

            //sort items in pile to arrays:
            var jackets = getTypes('Jacket', items);
            var indexJackets = 0;
            var shirts = getTypes('Shirt', items);
            var indexShirts = 0;
            var pants = getTypes('Pants', items);
            var indexPants = 0;
            var shoes = getTypes('Shoes', items);
            var indexShoes = 0;

            //show first outfit
            if(jackets.length > 0)
            {
                document.querySelector(".outfit-image").getSVGDocument().querySelector("#jacket path").style.fill = jackets[indexJackets].color;
                indexJackets = circleI(indexJackets, jackets);
            }
            if(shirts.length > 0)
            {
                document.querySelector(".outfit-image").getSVGDocument().querySelector("#t-shirt path").style.fill = shirts[indexShirts].color;
                indexShirts = circleI(indexShirts, shirts);
                //console.log(shirts);
            }
            if(pants.length > 0)
            {
                document.querySelector(".outfit-image").getSVGDocument().querySelector("#pants path").style.fill = pants[indexPants].color;
                indexPants = circleI(indexPants, pants);
            }
            if(shoes.length > 0)
            {
                document.querySelector(".outfit-image").getSVGDocument().querySelector("#shoes-color path").style.fill = shoes[indexShoes].color;
                document.querySelector(".outfit-image").getSVGDocument().querySelector("#shoes-color1 path").style.fill = shoes[indexShoes].color;
                indexShoes = circleI(indexShoes, shoes);
            }

            //TODO: clicks (same code, could be codensed)
            document.getElementById("change-jacket").addEventListener("click", function() {
                if(jackets.length > 0)
                {
                    document.querySelector(".outfit-image").getSVGDocument().querySelector("#jacket path").style.fill = jackets[indexJackets].color;
                    indexJackets = circleI(indexJackets, jackets);
                    $('.jackets').html('Jacket: ' + jackets[indexJackets].name + '<br>');
                    updateTweet(jackets, indexJackets, shirts, indexShirts, pants, indexPants, shoes, indexShoes);
                }
            });
            document.getElementById("change-shirt").addEventListener("click", function() {
                if(shirts.length > 0)
                {
                    document.querySelector(".outfit-image").getSVGDocument().querySelector("#t-shirt path").style.fill = shirts[indexShirts].color;
                    $('.shirts').html('Shirt: ' + shirts[indexShirts].name + '<br>');
                    indexShirts = circleI(indexShirts, shirts);
                    updateTweet(jackets, indexJackets, shirts, indexShirts, pants, indexPants, shoes, indexShoes);
                }
            });
            document.getElementById("change-pants").addEventListener("click", function() {
                if(pants.length > 0)
                {
                    document.querySelector(".outfit-image").getSVGDocument().querySelector("#pants path").style.fill = pants[indexPants].color;
                    $('.pants').html('Pants: ' + pants[indexPants].name + '<br>');
                    indexPants = circleI(indexPants, pants);
                    updateTweet(jackets, indexJackets, shirts, indexShirts, pants, indexPants, shoes, indexShoes);
                }
            });
            document.getElementById("change-shoes").addEventListener("click", function() {
                if(shoes.length > 0)
                {
                    document.querySelector(".outfit-image").getSVGDocument().querySelector("#shoes-color path").style.fill = shoes[indexShoes].color;
                    document.querySelector(".outfit-image").getSVGDocument().querySelector("#shoes-color1 path").style.fill = shoes[indexShoes].color;
                    $('.shoes').html('Shoes: ' + shoes[indexShoes].name + '<br>');
                    indexShoes = circleI(indexShoes, shoes);
                    updateTweet(jackets, indexJackets, shirts, indexShirts, pants, indexPants, shoes, indexShoes);
                }
            });

            // change instruction text to outfit
            $('.notice').html('');
            if(jackets.length > 0) { $('.jackets').html('Jacket: ' + jackets[indexJackets].name + '<br>');}
            if(shirts.length > 0) { $('.shirts').html('Shirt: ' + shirts[indexShirts].name + '<br>');}
            if(pants.length > 0) { $('.pants').html('Pants: ' + pants[indexPants].name + '<br>');}
            if(shoes.length > 0) { $('.shoes').html('Shoes: ' + shoes[indexShoes].name + '<br>');}
            updateTweet(jackets, indexJackets, shirts, indexShirts, pants, indexPants, shoes, indexShoes);
        },
    });
    $.ajax({
        type : "POST",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        url : "/generate?clothes=no",
        data: JSON.stringify({
                  'casual-generate': casualGenerate,
                  'temp-generate': tempGenerate,
               }),
        success: function (data, status) {
            $('.all-combos-container').css('display', 'block');
            
            for(i = 0; i < data.length; i++)
            {
                var card = $('<div class="card m-3 p-3 float-left">');
                for(j = 0; j < data[i].length; j++)
                {
                    card.append( data[i][j].name + ' ' + data[i][j].type + '<br>');
                }
                card.append('</div>');
                $('#all-combos').append(card);
            }
            
        }
    });
});
</script>
<script>
//script to remove rows
  var $table = $('#table')
  var $button = $('#remover')

  $(function() {
    $button.click(function () {
        
        //finds which rows are checked
        var ids = $.map($table.bootstrapTable('getSelections'), function (row,$element) {
            return row
        })
        console.log(ids)
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: "/remove",
            data: JSON.stringify(ids),
            success: function (data) {
                console.log(data);
            },
            dataType: "json"
        });
        //ids the tables for removing
        $('#table').bootstrapTable('checkAll')
        var rows = $('#table').bootstrapTable('getSelections')
        $.each(rows,function(index,element){
            element.id = index
        })
        $('#table').bootstrapTable('uncheckAll')

        //gets the id of the table to remove
        var idss = []
        $.each(ids,function(index,element){
             idss.push(element.id)
        }) 
        
        //removes the table
        $table.bootstrapTable('remove', {
        field: 'id',
        values: idss
        })
    })
  })
</script>

<script>

//May not need all of this checking - since JS/Bootstrap has options to make field "required"
//need to determine what fields are needed based on the type, then we can check here that the correct fields are filled (and disable the unused ones?)
function addClothes(){
	//provides a form for the user to enter information on their clothing item
    //this will create a new clothing item that will be displayed in wardrobe and added to database
    var text = document.getElementById("validater");
    var typesel = document.getElementById("typesel").value;
    var name = document.getElementById("name").value;
    var color = document.getElementById("color").value;
    var casual = document.getElementById("casual").value;
    var high = document.getElementById("high").value;
    var low = document.getElementById("low").value;
    var items = document.getElementsByClassName("form-control");
    for(var i=0;i<items.length;i++){
		if(!(items[i]&&items[i].value)){
            text.innerHTML = "Please enter all fields";
            return false;
        }
	}
    if(parseInt(high)<low){
        text.innerHTML = "Please enter a higher temperature for your high temperature";
        return false;
    }
    
    //return true if there are no issues (this will submit)
    return true;
}

//Selected item(s) will be removed from the user's wardrobe and also from the database

</script>
{% endblock %}